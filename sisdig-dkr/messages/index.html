<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>Chat • SISDIG DKR</title>

<link rel="icon" href="../assets/images/etaicon.png">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">

<style>
*{box-sizing:border-box;font-family:Poppins;margin:0}
body{background:#f1f5f9;height:100vh;overflow:hidden}

/* HEADER */
.header{
  background:#2563eb;
  color:white;
  padding:14px;
  display:flex;
  align-items:center;
  gap:10px;
  font-weight:600;
}
.header i{font-size:22px;cursor:pointer}
.header .theme-toggle{margin-left:auto;font-size:20px;cursor:pointer}

/* LAYOUT */
.wrap{
  position:relative;
  height:calc(100vh - 56px); /* header tetap */
}

/* SIDEBAR */
.sidebar{
  position:absolute;
  inset:0;
  background:white;
  display:flex;
  flex-direction:column;
  z-index:1;
}
.search{padding:10px}
.search input{
  width:100%;
  padding:8px 10px;
  border-radius:10px;
  border:1px solid #e5e7eb;
}
.list{flex:1;overflow-y:auto}

/* ITEM */
.item{
  padding:8px 12px;
  border-bottom:1px solid #f1f5f9;
  cursor:pointer;
  display:flex;
  align-items:center;
  gap:10px;
  height:56px;
}
.item:hover{background:#f1f5f9}

/* CHAT FULLSCREEN */
.chat{
  position:absolute;
  inset:0;
  background:#f1f5f9;
  display:none;
  flex-direction:column;
  z-index:2;
}

.chat.show{display:flex}

.chat-head{
  background:#2563eb;
  color:white;
  padding:12px;
  display:flex;
  align-items:center;
  gap:10px;
  font-weight:600;
}
.chat-head img{
  width:36px;
  height:36px;
  border-radius:50%;
  object-fit:cover;
  background:#e5e7eb;
}
.exit-chat{
  background:none;
  border:none;
  font-size:22px;
  color:white;
  cursor:pointer;
}

.chat-body{
  flex:1;
  padding:14px;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  gap:6px;
}
.msg{
  display:inline-block;
  padding:10px 14px;
  border-radius:20px;
  font-size:14px;
  max-width:70%;
  word-wrap:break-word;
}
.msg.me{
  align-self:flex-end;
  background:#2563eb;
  color:white;
  border-bottom-right-radius:4px;
}
.msg.other{
  align-self:flex-start;
  background:#e5e7eb;
  color:#000;
  border-bottom-left-radius:4px;
}

/* INPUT */
.chat-input{
  display:flex;
  background:white;
  border-top:1px solid #e5e7eb;
}
.chat-input input{
  flex:1;
  padding:12px;
  border:none;
  font-size:14px;
}
.chat-input button{
  background:#2563eb;
  color:white;
  border:none;
  padding:0 18px;
  cursor:pointer;
}

/* DARK MODE */
body.dark{background:#1e293b;color:white}
body.dark .sidebar{background:#111827;color:white}
body.dark .chat{background:#1e293b}
body.dark .chat-input{background:#111827;border-top:1px solid #374151}
body.dark .chat-input input{background:#1e293b;color:white}
body.dark .msg.other{background:#334155;color:white}

/* TOAST */
.toast{
  position:fixed;
  bottom:20px;
  right:20px;
  background:#2563eb;
  color:white;
  padding:10px 16px;
  border-radius:8px;
  opacity:0;
  transform:translateY(20px);
  transition:.3s;
  z-index:9999;
}
.toast.show{opacity:1;transform:translateY(0)}

/* Saat room chat aktif */
body.in-chat .header{
  display:none;
}

body.in-chat .wrap{
  height:100vh;
}

body.in-chat .chat{
  position:fixed;
  inset:0;
  z-index:10;
}

</style>
</head>

<body>

<div class="header">
  <i class='bx bx-arrow-back' onclick="location.href='../index.html'"></i>
  <img src="../assets/images/etanolw.png" style="height:28px">
  <i class='bx bx-moon theme-toggle' id="themeToggle"></i>
</div>

<div class="wrap">
  <div class="sidebar">
    <div class="search">
      <input id="search" placeholder="Cari anggota...">
    </div>
    <div class="list" id="list"></div>
  </div>

  <div class="chat" id="chat">
    <div class="chat-head">
      <button class="exit-chat" onclick="closeChat()"><i class='bx bx-arrow-back'></i></button>
      <img id="chatAvatar" src="default.png">
      <span id="chatTitle">Chat</span>
    </div>
    <div class="chat-body" id="msgs">
      <div style="color:#94a3b8;text-align:center;margin-top:20px">
        Chat ini terenkripsi. Aman & Privat.
      </div>
    </div>
    <div class="chat-input">
      <input id="input" placeholder="Ketik pesan...">
      <button onclick="send()">Kirim</button>
    </div>
  </div>
</div>

<script>
const ACCOUNT_API="https://script.google.com/macros/s/AKfycbwZxsptyOx8LDRdvhW3nCl4RBmnyI-5zBuD_0ZTm702bO8wJpjdLVEfg6tT3p1BY2M7/exec";
const CHAT_URL="https://script.google.com/macros/s/AKfycbz_OJAe5_yluNlxXskAVRoInYOi4Ma15Ofm4RC4JboEC7CbQBDHzi0XrUgQ7ylWVco/exec";

const me=(sessionStorage.getItem("SISDIG_USERNAME")||"").toLowerCase();
if(!me) location.href="../login.html";

let usersMap={},allItems=[],lastMessages=[],target=null,chatTimer=null;

function loadAccounts(){
  const s=document.createElement("script");
  s.src=ACCOUNT_API+"?callback=accountsLoaded&t="+Date.now();
  document.body.appendChild(s);
}
function accountsLoaded(data){
  data.forEach(u=>{
    usersMap[u.username.toLowerCase()]={nama:u.nama_lengkap||u.username,foto:u.foto||"default.png"};
  });
  inject("?users=1","users");
}
function inject(q,cb){
  const s=document.createElement("script");
  s.src=CHAT_URL+q+"&callback="+cb+"&t="+Date.now();
  document.body.appendChild(s);
}
function users(data){
  allItems=[];list.innerHTML="";
  data.forEach(u=>u!==me&&allItems.push({id:u,name:u}));
  renderList();
}
function renderList(arr=allItems){
  list.innerHTML="";
  arr.forEach(i=>{
    const acc=usersMap[i.id]||{};
    const d=document.createElement("div");
    d.className="item";
    d.innerHTML=`
      <img src="${acc.foto||'default.png'}" style="width:40px;height:40px;border-radius:50%">
      <div>${acc.nama||i.name}</div>`;
    d.onclick=()=>openChat(i);
    list.appendChild(d);
  });
}
function openChat(i){
  document.body.classList.add("in-chat"); // ⬅️ INI

  target=i.id;
  lastMessages=[];
  msgs.innerHTML="";
  const acc = usersMap[i.id] || {};
  chatTitle.textContent = acc.nama || i.name;
  chatAvatar.src = acc.foto || "default.png";
  chat.classList.add("show");
  fetchChat();
  if(chatTimer) clearInterval(chatTimer);
  chatTimer = setInterval(fetchChat,2000);
}
function closeChat(){
  document.body.classList.remove("in-chat"); // ⬅️ INI

  target=null;
  chat.classList.remove("show");
  msgs.innerHTML = `<div style="color:#94a3b8;text-align:center;margin-top:20px;">
    Pilih chat untuk mulai percakapan
  </div>`;
  if(chatTimer) clearInterval(chatTimer);
}
function fetchChat(){
  if(!target) return;
  const cb="cb"+Date.now();
  window[cb]=d=>{renderChat(d);delete window[cb]};
  const s=document.createElement("script");
  s.src=CHAT_URL+"?from="+me+"&to="+target+"&callback="+cb;
  document.body.appendChild(s);
}
function renderChat(data){
  data.slice(lastMessages.length).forEach(m=>{
    const d=document.createElement("div");
    d.className="msg "+(m.from===me?"me":"other");
    d.textContent=m.text;
    msgs.appendChild(d);
  });
  lastMessages=data;
  msgs.scrollTop=msgs.scrollHeight;
}
function send(){
  if(!input.value||!target) return;
  new Image().src=CHAT_URL+"?send=1&from="+me+"&to="+target+"&text="+encodeURIComponent(input.value);
  input.value="";
}
loadAccounts();
</script>

<script>
const themeToggle = document.getElementById("themeToggle");

function applyTheme(){
  const mode = localStorage.getItem("chat-theme") || "light";
  if(mode==="dark"){
    document.body.classList.add("dark");
    themeToggle.className="bx bx-sun theme-toggle";
  }else{
    document.body.classList.remove("dark");
    themeToggle.className="bx bx-moon theme-toggle";
  }
}

themeToggle.onclick = ()=>{
  const isDark = document.body.classList.toggle("dark");
  localStorage.setItem("chat-theme", isDark ? "dark":"light");
  applyTheme();
};

applyTheme();
</script>

</body>
</html>
