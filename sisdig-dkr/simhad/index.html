<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SIMHAD DKR Punggelan — Sistem Informasi Manajemen Kehadiran</title>
  <link rel="icon" href="../assets/images/logo.png" type="image/png">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
  <style>
    :root{
      --primary:#2563eb;
      --secondary:#00193b;
      --bg:#f4f6f8;
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
    }
    [data-theme="dark"]{
      --bg:#0f172a;
      --card:#1e293b;
      --text:#f8fafc;
      --muted:#94a3b8;
    }
    *{box-sizing:border-box;font-family:'Poppins',sans-serif}
    body{margin:0;background:var(--bg);color:var(--text);transition:.3s}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 24px;background:var(--card);box-shadow:0 6px 20px rgba(0,0,0,.08);border-bottom:2px solid var(--primary);flex-wrap:wrap}
    .brand{display:flex;gap:14px;align-items:center}
    .brand img{width:64px;height:64px;object-fit:contain}
    .brand h1{margin:0;font-size:20px;font-weight:700}
    .brand p{margin:2px 0 0;font-size:13px;color:var(--muted)}
    .header-info{display:flex;gap:20px;font-size:14px;color:var(--muted);align-items:center}
    .header-info div{display:flex;align-items:center;gap:6px}
    .container{max-width:1200px;margin:28px auto;padding:0 20px;display:grid;grid-template-columns:2fr 1fr;gap:20px}
    .card{background:var(--card);border-radius:14px;padding:22px;box-shadow:0 8px 26px rgba(0,0,0,.07)}
    h3{margin:0 0 12px;font-size:17px;display:flex;gap:6px;align-items:center}
    label{font-size:12px;color:var(--muted);margin-top:8px;display:block}
    input,select{width:100%;padding:10px 12px;margin-top:4px;border:1px solid #e5e7eb;border-radius:8px;font-size:14px}
    button{background:var(--primary);color:#fff;border:none;padding:10px 14px;border-radius:8px;font-weight:600;cursor:pointer}
    button.secondary{background:var(--secondary)}
    button.danger{background:#dc2626}
    button.small{padding:7px 10px;font-size:13px}
    .table-wrapper{margin-top:12px;border-radius:12px;overflow:hidden;border:1px solid #e5e7eb}
    table{width:100%;border-collapse:collapse;font-size:14px;background:var(--card)}
    thead{background:linear-gradient(to right, rgba(31,122,63,.08), rgba(139,94,60,.08))}
    th{padding:12px 10px;text-align:left;font-size:12px;letter-spacing:.5px;text-transform:uppercase;color:var(--text);border-bottom:2px solid #e5e7eb}
    td{padding:11px 10px;border-bottom:1px solid #e5e7eb;vertical-align:middle}
    tbody tr:nth-child(even){background:rgba(0,0,0,.02)}
    tbody tr:hover{background:rgba(31,122,63,.06)}
    td:last-child{text-align:center}
    td, th {word-wrap: break-word;word-break: break-word;white-space: normal}
    #attendanceTable th:nth-child(1),#attendanceTable td:nth-child(1){width:30%}
    #attendanceTable th:nth-child(2),#attendanceTable td:nth-child(2){width:30%}
    #attendanceTable th:nth-child(3),#attendanceTable td:nth-child(3){width:25%}
    #attendanceTable th:nth-child(4),#attendanceTable td:nth-child(4){width:15%}
    #reader{width:100%;max-height:260px;border-radius:10px;overflow:hidden}
    footer{text-align:center;margin:20px 0;font-size:12px;color:var(--muted);border-top:1px solid #e5e7eb;padding-top:8px}
    .footer-info{display:flex;justify-content:space-between;max-width:1200px;margin:0 auto;padding:0 20px}
    .toast-container{position:fixed;top:20px;right:20px;display:flex;flex-direction:column;gap:10px;z-index:999}
    .toast{background:var(--primary);color:#fff;padding:10px 16px;border-radius:8px;box-shadow:0 4px 14px rgba(0,0,0,.25);font-size:13px;opacity:0;transform:translateX(100%);transition:.3s}
    .toast.show{opacity:1;transform:translateX(0)}
    .toast.success{background:#15803d}
    .toast.error{background:#dc2626}
    .toast.info{background:#2563eb}
    @media(max-width:1000px){.container{grid-template-columns:1fr}}
    @media(max-width:768px){header{flex-direction:column;align-items:flex-start;padding:12px 16px}.brand{width:100%;justify-content:flex-start;gap:10px}.header-info{width:100%;flex-wrap:wrap;margin-top:8px;gap:12px;font-size:13px}footer .footer-info{flex-direction:column;gap:4px;font-size:11px;text-align:center}}
    /* ===== BOTTOM HOME BAR ===== */
.bottom-nav{
  position:fixed;
  bottom:12px;
  left:50%;
  transform:translateX(-50%);
  width:calc(100% - 24px);
  max-width:420px;
  background:#ffffff;
  border-radius:18px;
  box-shadow:0 12px 30px rgba(0,0,0,.18);
  display:flex;
  justify-content:center;
  z-index:999;
}

.bottom-nav button{
  flex:1;
  background:none;
  border:none;
  padding:14px 0;
  font-family:Poppins,sans-serif;
  font-size:13px;
  font-weight:600;
  color:#2563eb;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:4px;
  cursor:pointer;
}

.bottom-nav i{
  font-size:22px;
}

  </style>
</head>
<body data-theme="light">
<header>
  <div class="brand">
    <img src="../assets/images/logo.png" alt="DKR Punggelan">
    <div>
      <h1>SIMHAD DKR PUNGGELAN</h1>
      <p>Sistem Informasi Manajemen Kehadiran</p>
    </div>
  </div>
  <div class="header-info">
    <div><i class='bx bx-time'></i> <span id="currentTime">--:--:--</span></div>
    <div><i class='bx bx-wifi'></i> <span id="internetSpeed">-- Mbps</span></div>
    <div><i class='bx bx-chip'></i> Versi SIMHAD 1.0</div>
  </div>
</header>

<div class="container">
  <section class="card">
    <h3><i class='bx bx-qr-scan'></i> Scan QR Absensi</h3>
    <select id="camera-select"></select>
    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="small" onclick="restartScanner()">Mulai / Ganti Kamera</button>
      <button class="small danger" onclick="stopScanner()">Matikan Kamera</button>
    </div>
    <div id="reader" style="margin-top:10px"></div>

    <h3 style="margin-top:22px"><i class='bx bx-edit'></i> Absensi Manual</h3>
    <label>Nama</label>
    <input id="manualNama" placeholder="Nama anggota">
    <label>Jabatan</label>
    <select id="manualJabatan">
      <option value="">-- Pilih Jabatan --</option>
      <option>Ketua</option>
      <option>Wakil Ketua</option>
      <option>Sekretaris</option>
      <option>Bendahara</option>
      <option>Seksi Bidang Kajian Kepramukaan & Teknik Kepramukaan</option>
      <option>Seksi Bidang Kegiatan & Operasional</option>
      <option>Seksi Bidang Pembinaan & Pengembangan</option>
      <option>Seksi Bidang Penelitian & Evaluasi</option>
      <option>Unit Jurnalistik</option>
      <option value="lainnya">Lainnya</option>
    </select>
    <input id="manualJabatanLainnya" placeholder="Jabatan lainnya" style="display:none;margin-top:6px">
    <button id="addManual" style="margin-top:10px">Tambah Absensi</button>

    <h3 style="margin-top:24px"><i class='bx bx-list-check'></i> Daftar Hadir</h3>
    <div class="table-wrapper">
      <table id="attendanceTable">
        <thead><tr><th>Nama</th><th>Jabatan</th><th>Waktu</th><th>Aksi</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
      <button id="clearLog" class="small secondary">Bersihkan</button>
      <button id="exportCsv" class="small">Export CSV</button>
    </div>
  </section>

  <aside class="card">
    <h3><i class='bx bx-qr'></i> Generator QR</h3>
    <label>Nama</label>
    <input id="genNama" placeholder="Nama anggota">
    <label>Jabatan</label>
    <select id="genJabatan">
      <option value="">-- Pilih Jabatan --</option>
      <option>Ketua</option>
      <option>Wakil Ketua</option>
      <option>Sekretaris</option>
      <option>Bendahara</option>
      <option>Seksi Bidang Kajian Kepramukaan & Teknik Kepramukaan</option>
      <option>Seksi Bidang Kegiatan & Operasional</option>
      <option>Seksi Bidang Pembinaan & Pengembangan</option>
      <option>Seksi Bidang Penelitian & Evaluasi</option>
      <option>Unit Jurnalistik</option>
      <option value="lainnya">Lainnya</option>
    </select>
    <input id="genJabatanLainnya" placeholder="Jabatan lainnya" style="display:none;margin-top:6px">
    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
      <button id="generateQR">Buat QR</button>
      <button id="downloadQR" class="small secondary">Download</button>
    </div>
    <div id="qrCanvas" style="margin-top:14px;text-align:center"></div>

    <hr style="margin:22px 0">
    <h3><i class='bx bx-file'></i> Dokumen Absensi</h3>
    <label>Kegiatan</label>
    <input id="keterangan" placeholder="Contoh: Rapat DKR">
    <label>Tanggal</label>
    <input type="date" id="tanggal">
    <button id="downloadPdf" style="margin-top:10px">Download PDF</button>
  </aside>
</div>

<footer>
  <div class="footer-info">
    <span>© 2026 DKR Punggelan</span>
    <span id="footerTime">--:--:--</span>
  </div>
</footer>

<div class="toast-container" id="toastContainer"></div>

<script src="https://cdn.jsdelivr.net/npm/html5-qrcode/minified/html5-qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
// ===== LOGIC FINAL =====
const manualJabatan=document.getElementById('manualJabatan');
const manualJabatanLainnya=document.getElementById('manualJabatanLainnya');
const genJabatan=document.getElementById('genJabatan');
const genJabatanLainnya=document.getElementById('genJabatanLainnya');
manualJabatan.onchange=()=>manualJabatanLainnya.style.display=manualJabatan.value==='lainnya'?'block':'none';
genJabatan.onchange=()=>genJabatanLainnya.style.display=genJabatan.value==='lainnya'?'block':'none';

let attendance=JSON.parse(localStorage.getItem('attendance_dkr'))||[];
const tbody=document.querySelector('#attendanceTable tbody');
const manualNama=document.getElementById('manualNama');
const addManualBtn=document.getElementById('addManual');
const genNama=document.getElementById('genNama');
const qrCanvas=document.getElementById('qrCanvas');
const keterangan=document.getElementById('keterangan');
const tanggal=document.getElementById('tanggal');

if(!tanggal.value) tanggal.value=new Date().toISOString().slice(0,10);

function toast(msg,type='info'){
  const c=document.getElementById('toastContainer');
  const t=document.createElement('div');
  t.className='toast '+type;t.textContent=msg;c.appendChild(t);
  setTimeout(()=>t.classList.add('show'),50);
  setTimeout(()=>{t.classList.remove('show');setTimeout(()=>c.removeChild(t),300)},3000);
}
function save(){localStorage.setItem('attendance_dkr',JSON.stringify(attendance));}
function render(){
  if(!attendance.length){tbody.innerHTML='<tr><td colspan="4" style="text-align:center;color:#94a3b8">Belum ada data</td></tr>';return;}
  tbody.innerHTML=attendance.map((a,i)=>`<tr><td>${a.nama}</td><td>${a.jabatan}</td><td>${a.waktu}</td><td><button class="small danger" onclick="del(${i})"><i class='bx bx-trash'></i></button></td></tr>`).join('');
}
window.del=i=>{attendance.splice(i,1);save();render();toast('Data dihapus','success')}
function add(n,j){
  const record={nama:n,jabatan:j,waktu:new Date().toLocaleString('id-ID')};
  attendance.push(record);save();render();toast('Absensi ditambahkan','success');
  sendToSheets(record);
}

addManualBtn.onclick=()=>{
  const n=manualNama.value.trim();
  let j=manualJabatan.value==='lainnya'?manualJabatanLainnya.value.trim():manualJabatan.value;
  if(!n||!j) return toast('Lengkapi data','error');
  if(!attendance.some(a=>a.nama===n&&a.jabatan===j)) add(n,j);
  manualNama.value='';manualJabatan.value='';manualJabatanLainnya.value='';manualJabatanLainnya.style.display='none';
}

document.getElementById('generateQR').onclick=()=>{
  const n=genNama.value.trim();
  let j=genJabatan.value==='lainnya'?genJabatanLainnya.value.trim():genJabatan.value;
  if(!n||!j) return toast('Lengkapi data','error');
  qrCanvas.innerHTML='';
  const qrText=JSON.stringify({nama:n,jabatan:j}); // hanya nama & jabatan
  new QRCode(qrCanvas,{text:qrText,width:200,height:200});
  toast('QR dibuat','success');
}

document.getElementById('downloadQR').onclick=()=>{
  const img=qrCanvas.querySelector('img');if(!img) return toast('QR belum ada','error');
  const a=document.createElement('a');a.href=img.src;a.download='qr-dkr.png';a.click();
}

document.getElementById('clearLog').onclick=()=>{attendance=[];save();render();toast('Data dibersihkan','success')}
document.getElementById('exportCsv').onclick=()=>{
  if(!attendance.length) return toast('Data kosong','info');
  let csv='Nama,Jabatan,Waktu\n';
  attendance.forEach(a=>csv+=`${a.nama},${a.jabatan},${a.waktu}\n`);
  const blob=new Blob([csv],{type:'text/csv'});const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download='SIMHAD_DKR_Punggelan.csv';a.click();URL.revokeObjectURL(url);
}

// ===== QR SCANNER =====
let html5QrCode=null;const cameraSelect=document.getElementById('camera-select');
async function initCameras(){
  const cams=await Html5Qrcode.getCameras();if(!cams.length) return toast('Kamera tidak ditemukan','error');
  cameraSelect.innerHTML='';cams.forEach(c=>cameraSelect.add(new Option(c.label||'Camera',c.id)));
  startScanner(cameraSelect.value);
}
async function startScanner(id){
  if(html5QrCode){await html5QrCode.stop().catch(()=>{});html5QrCode.clear();}
  html5QrCode=new Html5Qrcode('reader');
  let last='';let lastTime=0;
  await html5QrCode.start({deviceId:{exact:id}},{fps:10,qrbox:250},txt=>{
    const now=Date.now();
    if(txt===last&&now-lastTime<3000) return;
    last=txt;lastTime=now;
    try{
      const o=JSON.parse(txt);
      const nama=o.nama||"";
      const jabatan=o.jabatan||"";
      if(nama&&jabatan&&!attendance.some(a=>a.nama===nama&&a.jabatan===jabatan)) add(nama,jabatan);
    }catch(err){console.log("QR tidak valid:",txt);}
  });
}
function restartScanner(){startScanner(cameraSelect.value)}
async function stopScanner(){if(html5QrCode) await html5QrCode.stop().catch(()=>{});html5QrCode.clear();}

// ===== PDF DOWNLOAD =====
document.getElementById('downloadPdf').onclick=()=>{
  if(!attendance.length) return toast('Data kosong','info');
  const { jsPDF } = window.jspdf;const doc=new jsPDF();
  const tgl=tanggal.value;const ket=keterangan.value||'-';
  doc.setFontSize(14);doc.text('DAFTAR HADIR',105,20,null,'center');doc.setFontSize(10);
  doc.text(`Kegiatan: ${ket}`,14,28);doc.text(`Tanggal: ${tgl}`,14,36);
  const startY=42;
  doc.autoTable({head:[['Nama','Jabatan','Waktu']],body:attendance.map(a=>[a.nama,a.jabatan,a.waktu]),startY,theme:'grid',styles:{fontSize:9}});
  doc.save(`Daftar_Hadir_${tgl}.pdf`);
  toast('PDF siap diunduh','success');
}

// ===== TIME & INTERNET SPEED =====
function updateTime(){const d=new Date();const t=d.toLocaleTimeString('id-ID');document.getElementById('currentTime').textContent=t;document.getElementById('footerTime').textContent=t;}
setInterval(updateTime,1000);updateTime();
async function updateInternetSpeed(){try{const start=performance.now();await fetch('https://www.google.com/favicon.ico');const end=performance.now();document.getElementById('internetSpeed').textContent=((1/(end-start)*1000).toFixed(2))+' Mbps'}catch(e){document.getElementById('internetSpeed').textContent='-- Mbps'}}
setInterval(updateInternetSpeed,5000);updateInternetSpeed();

// ===== SHEETS SIMULATION =====
function sendToSheets(record){console.log('Sent to Sheets:',record);}

// ===== INIT =====
render();initCameras();
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<!-- BOTTOM NAV -->
<div class="bottom-nav">
  <button onclick="location.href='../index.html'">
    <i class='bx bx-home'></i>
    Beranda
  </button>
</div>

</body>
</html>
