<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Keuangan DKR Punggelan</title>

<!-- Font & Icon -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
*{box-sizing:border-box;font-family:Poppins,sans-serif;margin:0;padding:0}
body{background:#f5f7fa;color:#1e293b;padding-bottom:100px;}

/* HEADER PROFESIONAL */
.header-professional{
  display:flex;
  align-items:center;
  justify-content:space-between;
  background:linear-gradient(135deg,#1e3a8a,#2563eb);
  color:white;
  padding:16px 24px;
  border-radius:0 0 24px 24px;
  box-shadow:0 6px 24px rgba(0,0,0,0.15);
  flex-wrap:wrap;
}
.header-left, .header-center, .header-right{
  display:flex;
  align-items:center;
}
.header-left{
  flex:0 0 auto;
}
.header-left .btn-back{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:8px 14px;
  background:rgba(255,255,255,0.1);
  color:white;
  border-radius:10px;
  font-weight:500;
  text-decoration:none;
  transition:.2s;
}
.header-left .btn-back:hover{background:rgba(255,255,255,0.2);}
.header-center{
  flex:1;
  flex-direction:column;
  text-align:center;
}
.header-center h1{
  font-size:20px;
  font-weight:700;
  margin-bottom:2px;
}
.header-center p{
  font-size:13px;
  color:rgba(255,255,255,0.9);
  margin:0;
}
.header-right{
  flex:0 0 auto;
}
.header-right .btn-notif{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width:40px;
  height:40px;
  border-radius:12px;
  background:rgba(255,255,255,0.1);
  color:white;
  font-size:20px;
  transition:.2s;
}
.header-right .btn-notif:hover{background:rgba(255,255,255,0.2);}
@media(max-width:640px){
  .header-professional{
    flex-direction:column;
    align-items:flex-start;
    gap:10px;
  }
  .header-center{text-align:left;width:100%;}
  .header-right{align-self:flex-end;}
}

/* FILTER MODERN */
.filter-box {
  display: flex;
  flex-wrap: wrap;
  gap: 16px;
  padding: 16px;
  background: white;
  border-radius: 16px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.08);
  margin: 20px;
  align-items: flex-end;
}
.filter-box .filter-item {
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.filter-box label {
  font-size: 13px;
  color: #64748b;
}
.filter-box select,
.filter-box input {
  padding: 8px 12px;
  border-radius: 10px;
  border: 1px solid #ccc;
  font-size: 14px;
  min-width: 150px;
}
.filter-box button {
  padding: 10px 20px;
  background: #2563eb;
  color: white;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  font-weight: 500;
  transition: .2s;
}
.filter-box button:hover {
  background: #1e40af;
}
@media(max-width:640px){
  .filter-box {
    flex-direction: column;
    align-items: stretch;
  }
  .filter-box .filter-item {
    width: 100%;
  }
}

/* SUMMARY GRID */
.summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:18px;padding:20px;}
.card{background:white;border-radius:16px;padding:18px;box-shadow:0 6px 20px rgba(0,0,0,.08);display:flex;align-items:center;gap:14px;transition:.3s;}
.card:hover{transform:translateY(-4px);box-shadow:0 10px 24px rgba(0,0,0,.12);}
.card .icon{width:54px;height:54px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:26px;color:white;}
.card .content{flex:1;}
.card .content .title{font-size:13px;font-weight:500;color:#64748b;}
.card .content .amount{font-size:17px;font-weight:600;}
.bg-blue{background:#2563eb;}
.bg-green{background:#16a34a;}
.bg-red{background:#dc2626;}
.bg-yellow{background:#f59e0b;}
.bg-purple{background:#7c3aed;}
.bg-orange{background:#f97316;}

/* DETAIL SECTION */
.detail-section{margin:20px;background:white;padding:20px;border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,.08);}
.detail-section h3{font-size:16px;font-weight:600;margin-bottom:14px;}
.detail-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;}
.detail-card{background:#f1f5f9;border-radius:12px;padding:14px;display:flex;align-items:center;gap:12px;}
.detail-card i{font-size:22px;color:#1e40af;}
.detail-card .info{flex:1;}
.detail-card .info .title{font-size:13px;color:#64748b;}
.detail-card .info .amount{font-size:15px;font-weight:600;}

/* CHART */
.chart-container{margin-top:24px;padding:10px;background:#f1f5f9;border-radius:14px;box-shadow:0 4px 12px rgba(0,0,0,.08);}

/* SPREADSHEET LINK */
.spreadsheet-link{margin:28px;text-align:center;}
.spreadsheet-link a{display:inline-block;padding:12px 24px;background:#1e40af;color:white;border-radius:12px;font-weight:500;text-decoration:none;box-shadow:0 6px 16px rgba(0,0,0,.12);transition:.2s;}
.spreadsheet-link a:hover{transform:scale(1.05);}

/* ===== BOTTOM HOME BAR ===== */
.bottom-nav{
  position:fixed;
  bottom:12px;
  left:50%;
  transform:translateX(-50%);
  width:calc(100% - 24px);
  max-width:420px;
  background:#ffffff;
  border-radius:18px;
  box-shadow:0 12px 30px rgba(0,0,0,.18);
  display:flex;
  justify-content:center;
  z-index:999;
}

.bottom-nav button{
  flex:1;
  background:none;
  border:none;
  padding:14px 0;
  font-family:Poppins,sans-serif;
  font-size:13px;
  font-weight:600;
  color:#2563eb;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:4px;
  cursor:pointer;
}

.bottom-nav i{
  font-size:22px;
}

</style>
</head>
<body>

<!-- HEADER -->
<div class="header-professional">
  <div class="header-left">
  </div>
  <div class="header-center">
    <h1>Keuangan DKR Punggelan</h1>
    <p>Ringkasan Pemasukan & Pengeluaran real-time</p>
  </div>
</div>

<!-- FILTER -->
<div class="filter-box">
  <div class="filter-item">
    <label>Bulan:</label>
    <select id="filterMonth">
      <option value="">Semua Bulan</option>
      <option value="0">Januari</option><option value="1">Februari</option><option value="2">Maret</option>
      <option value="3">April</option><option value="4">Mei</option><option value="5">Juni</option>
      <option value="6">Juli</option><option value="7">Agustus</option><option value="8">September</option>
      <option value="9">Oktober</option><option value="10">November</option><option value="11">Desember</option>
    </select>
  </div>
  <div class="filter-item">
    <label>Tanggal:</label>
    <input type="date" id="filterDate">
  </div>
  <div class="filter-item">
    <button id="btnFilter">Terapkan Filter</button>
  </div>
</div>
<div class="filter-box" id="crudBox" style="display:none">
  <div class="filter-item">
    <label>Tanggal</label>
    <input type="date" id="fTanggal">
  </div>
  <div class="filter-item">
    <label>Jenis</label>
    <select id="fJenis">
      <option value="Pemasukan">Pemasukan</option>
      <option value="Pengeluaran">Pengeluaran</option>
    </select>
  </div>
  <div class="filter-item">
    <label>Sumber</label>
    <input type="text" id="fSumber" placeholder="Kas / Donasi / ATK">
  </div>
  <div class="filter-item">
    <label>Jumlah</label>
    <input type="number" id="fJumlah">
  </div>
  <div class="filter-item">
    <label>Keterangan</label>
    <input type="text" id="fKet">
  </div>
  <div class="filter-item">
    <button onclick="submitKeuangan()">ðŸ’¾ Simpan</button>
  </div>
</div>

<!-- SUMMARY -->
<div class="summary-grid">
  <div class="card" style="border:2px solid #16a34a;">
  <div class="icon" style="background:#16a34a;"><i class='bx bx-wallet-alt'></i></div>
  <div class="content">
    <div class="title">Saldo Saat Ini</div>
    <div class="amount" id="currentBalance">Rp 0</div>
  </div>
</div>
  <div class="card"><div class="icon bg-green"><i class='bx bx-money'></i></div><div class="content"><div class="title">Pemasukan Hari Ini</div><div class="amount" id="incomeToday">Rp 0</div></div></div>
  <div class="card"><div class="icon bg-red"><i class='bx bx-credit-card'></i></div><div class="content"><div class="title">Pengeluaran Hari Ini</div><div class="amount" id="expenseToday">Rp 0</div></div></div>
  <div class="card"><div class="icon bg-blue"><i class='bx bx-calendar'></i></div><div class="content"><div class="title">Pemasukan Bulan Ini</div><div class="amount" id="incomeMonth">Rp 0</div></div></div>
  <div class="card"><div class="icon bg-yellow"><i class='bx bx-calendar-check'></i></div><div class="content"><div class="title">Pengeluaran Bulan Ini</div><div class="amount" id="expenseMonth">Rp 0</div></div></div>
  <div class="card"><div class="icon bg-purple"><i class='bx bx-calendar-alt'></i></div><div class="content"><div class="title">Pemasukan Tahun Ini</div><div class="amount" id="incomeYear">Rp 0</div></div></div>
  <div class="card"><div class="icon bg-orange"><i class='bx bx-calendar-event'></i></div><div class="content"><div class="title">Pengeluaran Tahun Ini</div><div class="amount" id="expenseYear">Rp 0</div></div></div>
</div>

<!-- TOTAL -->
<div class="detail-section">
  <h3>Total Pemasukan & Pengeluaran</h3>
  <div class="detail-grid">
    <div class="detail-card"><i class='bx bx-wallet'></i><div class="info"><div class="title">Total Pemasukan</div><div class="amount" id="totalIncome">Rp 0</div></div></div>
    <div class="detail-card"><i class='bx bx-credit-card'></i><div class="info"><div class="title">Total Pengeluaran</div><div class="amount" id="totalExpense">Rp 0</div></div></div>
  </div>
</div>

<!-- SOURCES -->
<div class="detail-section">
  <h3>Data Pemasukan</h3>
  <div class="detail-grid" id="incomeSources"></div>
  <h3>Data Pengeluaran</h3>
  <div class="detail-grid" id="expenseSources"></div>
</div>

<!-- CHART -->
<div class="detail-section chart-container">
  <h3>Grafik Pemasukan & Pengeluaran Bulanan</h3>
  <canvas id="keuanganChart" height="100"></canvas>
</div>

<div class="spreadsheet-link">
  <a href="https://docs.google.com/spreadsheets/d/YOUR_SPREADSHEET_ID" target="_blank">Lihat Laporan Keuangan Lengkap</a>
</div>

<script>
const url = "https://script.google.com/macros/s/AKfycbyqnHicse7yDjvQD55R6hBnSzkUg0gSjlX-4Mldfe-DcXjZNuobXVDaBR9su7aiZsDr/exec";

async function fetchKeuangan(monthFilter='', dateFilter='') {
  try {
    const res = await fetch(url);
    let rows = await res.json();

    // Filter bulan
    if(monthFilter !== ''){
      rows = rows.filter(r => new Date(r.tanggal).getMonth() == monthFilter);
    }
    // Filter tanggal (fix UTC)
    if(dateFilter !== ''){
      rows = rows.filter(r => {
        const d = new Date(r.tanggal);
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const dd = String(d.getDate()).padStart(2,'0');
        return `${yyyy}-${mm}-${dd}` === dateFilter;
      });
    }

    processKeuangan(rows);
  } catch(e) {
    console.error("Gagal ambil data:", e);
  }
}

document.getElementById("btnFilter").addEventListener("click", () => {
  const monthFilter = document.getElementById("filterMonth").value;
  const dateFilter = document.getElementById("filterDate").value;
  fetchKeuangan(monthFilter, dateFilter);
});

// Load awal
fetchKeuangan();

function processKeuangan(rows){
  const today=new Date();
  let incomeToday=0, expenseToday=0, incomeMonth=0, expenseMonth=0, incomeYear=0, expenseYear=0;
  let totalIncome=0, totalExpense=0;
  let incomeSources={}, expenseSources={};
  const monthlyIncome=Array(12).fill(0);
  const monthlyExpense=Array(12).fill(0);

  rows.forEach(r=>{
    const d=new Date(r.tanggal);
    const jenis=r.jenis;
    const jumlah=Number(r.jumlah||0);
    const sumber=r.sumber;

    if(jenis==="Pemasukan"){
      totalIncome+=jumlah;
      if(d.toDateString()===today.toDateString()) incomeToday+=jumlah;
      if(d.getMonth()===today.getMonth() && d.getFullYear()===today.getFullYear()) incomeMonth+=jumlah;
      if(d.getFullYear()===today.getFullYear()) incomeYear+=jumlah;
      incomeSources[sumber]=(incomeSources[sumber]||0)+jumlah;
      monthlyIncome[d.getMonth()]+=jumlah;
    } else {
      totalExpense+=jumlah;
      if(d.toDateString()===today.toDateString()) expenseToday+=jumlah;
      if(d.getMonth()===today.getMonth() && d.getFullYear()===today.getFullYear()) expenseMonth+=jumlah;
      if(d.getFullYear()===today.getFullYear()) expenseYear+=jumlah;
      expenseSources[sumber]=(expenseSources[sumber]||0)+jumlah;
      monthlyExpense[d.getMonth()]+=jumlah;
    }
  });

  document.getElementById("incomeToday").textContent=`Rp ${incomeToday.toLocaleString()}`;
  document.getElementById("expenseToday").textContent=`Rp ${expenseToday.toLocaleString()}`;
  document.getElementById("incomeMonth").textContent=`Rp ${incomeMonth.toLocaleString()}`;
  document.getElementById("expenseMonth").textContent=`Rp ${expenseMonth.toLocaleString()}`;
  document.getElementById("incomeYear").textContent=`Rp ${incomeYear.toLocaleString()}`;
  document.getElementById("expenseYear").textContent=`Rp ${expenseYear.toLocaleString()}`;
  document.getElementById("totalIncome").textContent=`Rp ${totalIncome.toLocaleString()}`;
  document.getElementById("totalExpense").textContent=`Rp ${totalExpense.toLocaleString()}`;
  const balance = totalIncome - totalExpense;
document.getElementById("currentBalance").textContent = `Rp ${balance.toLocaleString()}`;

  const incomeContainer=document.getElementById("incomeSources"); incomeContainer.innerHTML="";
  Object.entries(incomeSources).forEach(([src,amt])=>{
    const card=document.createElement("div"); card.className="detail-card";
    card.innerHTML=`<i class='bx bx-store'></i><div class="info"><div class="title">${src}</div><div class="amount">Rp ${amt.toLocaleString()}</div></div>`;
    incomeContainer.appendChild(card);
  });

  const expenseContainer=document.getElementById("expenseSources"); expenseContainer.innerHTML="";
  Object.entries(expenseSources).forEach(([src,amt])=>{
    const card=document.createElement("div"); card.className="detail-card";
    card.innerHTML=`<i class='bx bx-cart'></i><div class="info"><div class="title">${src}</div><div class="amount">Rp ${amt.toLocaleString()}</div></div>`;
    expenseContainer.appendChild(card);
  });

  // Chart
  const ctx=document.getElementById("keuanganChart").getContext("2d");
  if(window.myChart) window.myChart.destroy();
  window.myChart=new Chart(ctx,{
    type:'bar',
    data:{
      labels:['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Agu','Sep','Okt','Nov','Des'],
      datasets:[
        {label:'Pemasukan',data:monthlyIncome,backgroundColor:'#16a34a'},
        {label:'Pengeluaran',data:monthlyExpense,backgroundColor:'#dc2626'}
      ]
    },
    options:{responsive:true,plugins:{legend:{position:'top'}},scales:{y:{beginAtZero:true}}}
  });
}

function getRole(){
  return sessionStorage.getItem("SISDIG_ROLE") || "external";
}

function hasAccess(roles=[]){
  return roles.includes(getRole());
}

const allowedRoles = ["admin","admin_dev","bendahara"];

if(hasAccess(allowedRoles)){
  document.getElementById("crudBox").style.display = "flex";
}

</script>
<script>
const KEUANGAN_API = "https://script.google.com/macros/s/AKfycbyqnHicse7yDjvQD55R6hBnSzkUg0gSjlX-4Mldfe-DcXjZNuobXVDaBR9su7aiZsDr/exec";

function submitKeuangan() {
  const tanggal = document.getElementById("fTanggal").value;
  const jenis   = document.getElementById("fJenis").value;
  const sumber  = document.getElementById("fSumber").value;
  const jumlah  = document.getElementById("fJumlah").value;
  const ket     = document.getElementById("fKet").value;

  if (!tanggal || !jenis || !sumber || !jumlah) {
    alert("Lengkapi semua data");
    return;
  }

  fetch(KEUANGAN_API, {
    method: "POST",
    body: JSON.stringify({
      action: "add",
      tanggal,
      jenis,
      sumber,
      jumlah: Number(jumlah),
      keterangan: ket || ""
    })
  })
  .then(r => r.json())
  .then(res => {
    alert("Data keuangan tersimpan");
    fetchKeuangan(); // refresh TANPA reload
  })
  .catch(err => {
    console.error(err);
    alert("Gagal menyimpan data");
  });
}
</script>
<!-- BOTTOM NAV -->
<div class="bottom-nav">
  <button onclick="location.href='../index.html'">
    <i class='bx bx-home'></i>
    Beranda
  </button>
</div>

</body>
</html>
