<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Absensi Kegiatan • SISDIG</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
<link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
<style>
body{margin:0;font-family:Poppins,sans-serif;background:#f1f5f9;color:#0f172a;padding-bottom:80px}
.header{background:linear-gradient(135deg,#4f46e5,#2563eb);padding:18px;color:#fff;border-radius:0 0 24px 24px}
.header h1{margin:0;font-size:20px;text-align: center;}
.container{padding:16px}
.card{background:#fff;border-radius:18px;box-shadow:0 8px 24px rgba(0,0,0,.12);padding:16px;margin-bottom:20px}
.card h2{margin:0 0 6px;font-size:18px;color:#1e40af}
.meta{font-size:13px;color:#64748b}
.actions{display:flex;gap:12px;margin-top:14px}
.btn{flex:1;padding:12px;border:none;border-radius:14px;font-weight:600;cursor:pointer;font-size:14px}
.in{background:#10b981;color:#fff}
.out{background:#ef4444;color:#fff}
.disabled{opacity:.5;pointer-events:none}
.status{margin-top:12px;font-size:13px;font-weight:500}
.success{color:#10b981}
.error{color:#ef4444}
#adminPanel h2{margin-bottom:8px;color:#1e40af}
#adminPanel table{width:100%;border-collapse:collapse;margin-top:8px}
#adminPanel th, #adminPanel td{border:1px solid #ccc;padding:6px;text-align:center}
#adminPanel th{background:#e5e7eb}

/* ===== BOTTOM HOME BAR ===== */
.bottom-nav{
  position:fixed;
  bottom:12px;
  left:50%;
  transform:translateX(-50%);
  width:calc(100% - 24px);
  max-width:420px;
  background:#ffffff;
  border-radius:18px;
  box-shadow:0 12px 30px rgba(0,0,0,.18);
  display:flex;
  justify-content:center;
  z-index:999;
}

.bottom-nav button{
  flex:1;
  background:none;
  border:none;
  padding:14px 0;
  font-family:Poppins,sans-serif;
  font-size:13px;
  font-weight:600;
  color:#2563eb;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:4px;
  cursor:pointer;
}

.bottom-nav i{
  font-size:22px;
}

</style>
</head>
<body>

<div class="header">
  <h1>Absensi Kegiatan</h1>
</div>

<div class="container">
  <div id="card"></div>
  <div id="adminPanel"></div>
</div>

<script>
const ABSEN_API = "https://script.google.com/macros/s/AKfycbzyg7vbhgS1BnfPkWkC_mBSQNwLKkJu_hwdlM7Dg0mbSzKx51AEx6nd9TLRg5popwy_NA/exec";

let sudahCheckin = false;
let startTime = null;
let timerInterval = null;

const absenStatus = sessionStorage.getItem("SISDIG_ABSEN_STATUS");
const absenStart = sessionStorage.getItem("SISDIG_ABSEN_START");
const username = sessionStorage.getItem("SISDIG_USERNAME");
const kegiatan = JSON.parse(sessionStorage.getItem("SISDIG_KEGIATAN_AKTIF"));

if(absenStatus === "IN" && absenStart){
  sudahCheckin = true;
  startTime = new Date(parseInt(absenStart));
}

if(!username){
  document.getElementById("card").innerHTML = "<p style='text-align:center'>User belum login</p>";
}else{
  getUserRole(username).then(role=> loadKegiatan(role));
}

// ================= AMBIL ROLE =================
function getUserRole(username){
  return new Promise(resolve => {
    const cb = "cb_role_" + Date.now();
    window[cb] = res => { delete window[cb]; resolve(res.status==="ok"?res.role:"user"); };
    const s = document.createElement("script");
    s.src = ABSEN_API+"?action=userdata&callback="+cb+"&username="+encodeURIComponent(username);
    document.body.appendChild(s);
  });
}

// ================= RENDER CARD =================
function loadKegiatan(role){
  if(!kegiatan){
    document.getElementById("card").innerHTML = "<p style='text-align:center'>Tidak ada kegiatan aktif</p>";
    return;
  }
  renderCard(kegiatan);
  if(role === "admin" || role === "admin_dev") loadAdminPanel(kegiatan.id);
}

function formatTanggal(t){
  if(!t) return "-";
  const d = new Date(t);
  return d.toLocaleDateString("id-ID", {
    day: "2-digit",
    month: "long",
    year: "numeric"
  });
}

function renderCard(keg){
  document.getElementById("card").innerHTML = `
    <div class="card">
      <h2>${keg.nama}</h2>
      <div class="meta">
        <i class='bx bx-calendar'></i> ${formatTanggal(keg.tanggal)}<br>
        <i class='bx bx-time'></i> ${keg.waktu}<br>
        <i class='bx bx-map'></i> ${keg.lokasi}
      </div>
      <div id="timer" style="margin-top:10px;font-size:13px;color:#2563eb;font-weight:600">
        Durasi: 00:00:00
      </div>
      <div class="actions">
        <button id="btnIn" class="btn in"><i class='bx bx-log-in'></i> Check-in</button>
        <button id="btnOut" class="btn out disabled"><i class='bx bx-log-out'></i> Check-out</button>
      </div>
      <div id="status" class="status"></div>
    </div>
  `;

  const btnIn = document.getElementById("btnIn");
  const btnOut = document.getElementById("btnOut");

  if(sudahCheckin){
    btnIn.classList.add("disabled");
    btnOut.classList.remove("disabled");
    startTimer();
} else {
  // ✅ VALIDASI HARI-H SAJA (TANPA JAM)
const now = new Date();
const hariH = new Date(keg.tanggal);

if (now.toDateString() === hariH.toDateString()) {
  btnIn.onclick = () => absen('IN');
} else {
  btnIn.classList.add("disabled");
  btnIn.title = "Check-in hanya bisa dilakukan di hari kegiatan";
}
}

  btnOut.onclick = ()=>absen('OUT');
}

// ================= ABSEN =================
function absen(tipe){
  const payload = {username, tipe, kegiatan_id:kegiatan.id, kegiatan:kegiatan.nama, waktu_mulai:kegiatan.waktu};
  const cb = "cb_" + Date.now();
  window[cb]=res=>{
    delete window[cb];
    const statusEl = document.getElementById("status");
    statusEl.textContent=res.message;
    statusEl.className="status "+(res.status==="ok"?"success":"error");

    if(res.status==="ok" && tipe==="IN"){
      sudahCheckin=true;
      sessionStorage.setItem("SISDIG_ABSEN_STATUS","IN");
      sessionStorage.setItem("SISDIG_ABSEN_START", Date.now());
      document.getElementById("btnIn").classList.add("disabled");
      document.getElementById("btnOut").classList.remove("disabled");
      startTime=new Date();
      startTimer();
    }

    if(res.status==="ok" && tipe==="OUT"){
      sessionStorage.removeItem("SISDIG_ABSEN_STATUS");
      sessionStorage.removeItem("SISDIG_ABSEN_START");
      sessionStorage.removeItem("SISDIG_KEGIATAN_AKTIF");
      clearInterval(timerInterval);
      setTimeout(()=>location.href="../jadwal/index.html",1200);
    }
  };

  const s=document.createElement("script");
  s.src = ABSEN_API+"?action=absen&callback="+cb+"&data="+encodeURIComponent(JSON.stringify(payload));
  document.body.appendChild(s);
}

// ================= TIMER =================
function startTimer(){
  if(timerInterval) clearInterval(timerInterval);
  timerInterval=setInterval(()=>{
    const diff=new Date()-startTime;
    const h=String(Math.floor(diff/3600000)).padStart(2,'0');
    const m=String(Math.floor(diff%3600000/60000)).padStart(2,'0');
    const s=String(Math.floor(diff%60000/1000)).padStart(2,'0');
    const t=document.getElementById("timer");
    if(t) t.textContent=`Durasi: ${h}:${m}:${s}`;
  },1000);
}

// ================= PANEL ADMIN =================
function loadAdminPanel(kegiatan_id){
  const cb="cb_admin_"+Date.now();
  window[cb]=res=>{
    delete window[cb];
    if(res.status==="ok"){
      const panel=document.getElementById("adminPanel");
      let html=`<h2>Peserta Kegiatan</h2><table><thead><tr>
        <th>Username</th><th>Check-in</th><th>Check-out</th><th>Status</th>
      </tr></thead><tbody>`;
      res.data.forEach(p=>{
        html+=`<tr>
          <td>${p.username}</td>
          <td>${p.checkin||'-'}</td>
          <td>${p.checkout||'-'}</td>
          <td>${p.status||'-'}</td>
        </tr>`;
      });
      html+=`</tbody></table>`;
      panel.innerHTML=html;
    }
  };
  const s=document.createElement("script");
  s.src=ABSEN_API+"?action=admin&callback="+cb+"&kegiatan_id="+encodeURIComponent(kegiatan_id);
  document.body.appendChild(s);
}
</script>

<!-- BOTTOM NAV -->
<div class="bottom-nav">
  <button onclick="location.href='../index.html'">
    <i class='bx bx-home'></i>
    Beranda
  </button>
</div>

</body>
</html>
