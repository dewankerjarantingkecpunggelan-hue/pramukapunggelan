<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Akun Saya — SISDIG DKR</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
<link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">

<style>
:root{
  --primary:#2563eb;
  --bg:#f4f6fb;
  --border:#e5e7eb;
  --text:#0f172a;
  --muted:#64748b;
  --card:#ffffff;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:Poppins,sans-serif;
  background:var(--bg);
  color:var(--text);
}

/* HEADER */
.topbar{
  display:flex;
  align-items:center;
  gap:12px;
  padding:14px 16px;
  background:white;
  border-bottom:1px solid var(--border);
}

.back-btn{
  width:40px;
  height:40px;
  border-radius:10px;
  border:none;
  background:#eef2ff;
  color:var(--primary);
  font-size:20px;
}

.topbar h1{
  font-size:18px;
  margin:0;
  font-weight:600;
}

/* CONTAINER */
.container{
  max-width:640px;
  margin:20px auto;
  padding:16px;
}

/* PROFILE CARD */
.profile-card{
  background:var(--card);
  border-radius:16px;
  padding:20px;
  text-align:center;
}

.avatar{
  width:110px;
  height:110px;
  margin:0 auto 12px;
  border-radius:50%;
  overflow:hidden;
  background:#e5e7eb;
  cursor:pointer;
}

.avatar img{
  width:100%;
  height:100%;
  object-fit:cover;
}

.profile-card h2{
  margin:6px 0 2px;
  font-size:20px;
  font-weight:600;
}

.profile-card p{
  margin:0;
  font-size:14px;
  color:var(--muted);
}

/* SECTION */
.section{
  background:white;
  border-radius:16px;
  padding:18px;
  margin-top:16px;
}

.section h3{
  margin:0 0 12px;
  font-size:15px;
  font-weight:600;
  color:#334155;
}

/* FORM */
.form-group{
  margin-bottom:14px;
}

.form-group label{
  display:block;
  font-size:13px;
  margin-bottom:4px;
  color:#475569;
}

.form-group input{
  width:100%;
  padding:11px 12px;
  border-radius:10px;
  border:1px solid var(--border);
  font-size:14px;
  background:white;
}

.form-group input[readonly]{
  background:#f1f5f9;
  color:#475569;
}

/* BUTTON */
.btn-primary{
  width:100%;
  padding:13px;
  border-radius:12px;
  border:none;
  font-size:15px;
  font-weight:600;
  background:var(--primary);
  color:white;
}

.btn-secondary{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid var(--border);
  background:white;
  font-size:14px;
  margin-top:10px;
}

/* RESPONSIVE */
@media(max-width:420px){
  .container{padding:12px}
}
</style>
</head>
<body>

<div class="topbar">
  <button class="back-btn" onclick="location.href='../index.html'">
    <i class='bx bx-arrow-back'></i>
  </button>
  <h1>Akun Saya</h1>
</div>

<div class="container">
  <!-- PROFILE -->
  <div class="profile-card">
    <div class="avatar" onclick="pickPhoto()">
      <img id="avatarImg" src="default.png" alt="Avatar">
    </div>
    <h2 id="namaTitle">Nama Anggota</h2>
    <p id="jabatanTitle">Jabatan</p>
    <input type="file" id="fotoInput" accept="image/*" hidden>
  </div>

  <!-- DATA UTAMA -->
  <div class="section">
    <h3>Informasi Akun</h3>
    <div class="form-group"><label>Username</label><input id="username" readonly></div>
    <div class="form-group"><label>SID ID</label><input id="sid_id" readonly></div>
    <div class="form-group"><label>No NTA</label><input id="no_nta" readonly></div>
  </div>

  <!-- DATA PRIBADI -->
  <div class="section">
    <h3>Data Pribadi</h3>
    <div class="form-group"><label>Nama Lengkap</label><input id="nama_lengkap"></div>
    <div class="form-group"><label>Email</label><input id="email"></div>
    <div class="form-group"><label>Telepon</label><input id="telp"></div>
    <div class="form-group"><label>Alamat</label><input id="alamat"></div>

    <button class="btn-primary" onclick="saveProfile()"><i class='bx bx-save'></i> Simpan Perubahan</button>
    <button class="btn-secondary" onclick="changePassword()"><i class='bx bx-key'></i> Ganti Password</button>
  </div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbwZxsptyOx8LDRdvhW3nCl4RBmnyI-5zBuD_0ZTm702bO8wJpjdLVEfg6tT3p1BY2M7/exec";
const DEFAULT_AVATAR = "default.png";
const USERNAME = sessionStorage.getItem("SISDIG_USERNAME");
if(!USERNAME) location.href="../login.html";

function safe(val, def=""){ return val||def; }

function getRole(){
  return sessionStorage.getItem("SISDIG_ROLE") || "external";
}

function hasAccess(roles=[]){
  return roles.includes(getRole());
}

// SET AVATAR DARI BASE64 LANGSUNG
function setAvatar(base64){
  const img = document.getElementById("avatarImg");
  img.src = base64 || DEFAULT_AVATAR;
}

// TAMPILKAN DATA USER
function displayAccount(data){
  if(!Array.isArray(data)) return;
  const u = data.find(x=>x.username===USERNAME);
  if(!u) return;

  document.getElementById("username").value = safe(u.username);
  document.getElementById("nama_lengkap").value = safe(u.nama_lengkap);
  document.getElementById("sid_id").value = safe(u.sid_id);
  document.getElementById("no_nta").value = safe(u.no_nta);
  document.getElementById("email").value = safe(u.email);
  document.getElementById("telp").value = safe(u.telp);
  document.getElementById("alamat").value = safe(u.alamat);

  document.getElementById("namaTitle").textContent = safe(u.nama_lengkap,"Anggota");
  document.getElementById("jabatanTitle").textContent = safe(u.jabatan,"-");

  // BASE64 LANGSUNG → bebas CORB
  setAvatar(u.foto);
}

// LOAD DATA DARI APPS SCRIPT (JSONP)
(function(){
  const s=document.createElement("script");
  s.src = API + "?callback=" + encodeURIComponent("displayAccount") + "&t=" + Date.now();
  document.body.appendChild(s);
})();

// SIMPAN PERUBAHAN PROFIL
function saveProfile(){
  fetch(API,{
    method:"POST",
    body:JSON.stringify({
      action:"update_profile",
      username:document.getElementById("username").value,
      nama_lengkap:document.getElementById("nama_lengkap").value,
      telp:document.getElementById("telp").value,
      email:document.getElementById("email").value,
      alamat:document.getElementById("alamat").value
    })
  })
  .then(r=>r.json())
  .then(r=>{ alert(r.status==="ok"?"✅ Profil disimpan":"❌ Gagal menyimpan"); })
  .catch(()=>alert("❌ Koneksi gagal"));
}

// PICK FOTO
function pickPhoto(){ document.getElementById("fotoInput").click(); }

document.getElementById("fotoInput").onchange=function(){
  if(!this.files[0]) return;
  const fr=new FileReader();
  fr.onload=()=>{
    fetch(API,{
      method:"POST",
      body:JSON.stringify({
        action:"upload_photo",
        username:document.getElementById("username").value,
        file:fr.result
      })
    })
    .then(r=>r.json())
    .then(r=>{
      if(r.status==="ok"){ 
        setAvatar(r.foto); 
        alert("✅ Foto diupdate"); 
      } else alert("❌ Upload gagal");
    })
    .catch(()=>alert("❌ Upload gagal"));
  };
  fr.readAsDataURL(this.files[0]);
};

// GANTI PASSWORD
function changePassword(){ alert("Hubungi admin untuk ganti password"); }
</script>
</body>
</html>
